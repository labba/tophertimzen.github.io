<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Services</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="..\slideResources\theme\css\print.css">
    <link rel="stylesheet" media="screen, projection" href="..\slideResources\theme\css\screen.css">
    
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="..\slideResources\theme\js\slides.js"></script>
    
    
    
    <!-- /Javascripts -->
</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-1">
          <div class="inner">
            
            <header><h1>Services</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              1/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-2">
          <div class="inner">
            
            <header><h1>What</h1></header>
            
            
            <section><p>What services are</p>
<p>Installing Services</p>
<p>How Malware uses services</p>
<p>Finding hidden services</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              2/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-3">
          <div class="inner">
            
            <header><h1>Services</h1></header>
            
            
            <section><p>Non-interactive background processes.</p>
<p>Commonly run with higher privileges than the user</p>
<p>What runs as services?</p>
<ul>
<li>Anti-virus</li>
<li>Event-logging</li>
<li>Print spooler</li>
<li>Firewall</li>
<li>DHCP Client</li>
<li>Application updaters</li>
<li>Network monitoring</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              3/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-4">
          <div class="inner">
            
            <header><h1>Service Architecture</h1></header>
            
            
            <section><p>Installed services located in <strong>HKLM/SYSTEM/CurrentControlSet/Services</strong></p>
<p><img alt="services" src="..\slideResources\services\services.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              4/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-5">
          <div class="inner">
            
            <header><h1>Subkeys</h1></header>
            
            
            <section><p>Each service has a subkey with various values that describe how and when the service starts.</p>
<p>Also shows if the service is for a process, DLL or kernel driver.</p>
<p><img alt="dhcp" src="..\slideResources\services\dhcp.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              5/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-6">
          <div class="inner">
            
            <header><h1>Components</h1></header>
            
            
            <section><p><img alt="components" src="..\slideResources\services\components.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              6/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-7">
          <div class="inner">
            
            <header><h1>Installing Services</h1></header>
            
            
            <section><p>Manually with sc.exe</p>
<p>Batch Scripts</p>
<ul>
<li>Malware commonly drops and executes batch scripts</li>
<li>Creates disk artifacts</li>
</ul>
<p>Windows API</p>
<ul>
<li>CreateService and StartService.</li>
<li>SC.exe is front end to API</li>
<li>CreateService adds a subkey to the registry and StartService leaves logs </li>
</ul>
<p>Windows Management Instrumentation (WMI)</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              7/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-8">
          <div class="inner">
            
            <header><h1>Sc.exe</h1></header>
            
            
            <section><p>How to install service with sc?</p>
<div class="highlight"><pre><span class="p">@</span><span class="k">echo</span> <span class="k">off</span>
<span class="k">set</span> <span class="nv">SERVICENAME</span><span class="o">=</span><span class="s2">&quot;Malware&quot;</span>
<span class="k">set</span> <span class="nv">BINPATH</span><span class="o">=</span><span class="s2">&quot;c:\bin\malware.dll&quot;</span>

sc create <span class="s2">&quot;%SERVICENAME&quot;</span> binPath<span class="o">=</span> <span class="s2">&quot;%SystemRoot%\system32\svchost.exe&quot;</span> -k <span class="s2">&quot;%SERVICENAME&quot;</span> type<span class="o">=</span> share start<span class="o">=</span> auto

reg add <span class="s2">&quot;HKLM\System\CurrentCOntrolSet\Services\%SERVICENAME\Parameters&quot;</span> <span class="n">/v</span> ServiceDll <span class="n">/t</span> REG_EXPAND_SZ <span class="n">/d</span> <span class="s2">&quot;%BINPATH%&quot;</span> <span class="n">/f</span>

sc start <span class="nv">%SERVICENAME%</span>
</pre></div>

<p><br><br></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              8/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-9">
          <div class="inner">
            
            <header><h1>WinAPI</h1></header>
            
            
            <section><p><br></p>
<div class="highlight"><pre>SC_HANDLE WINAPI CreateService(
  _In_       SC_HANDLE hSCManager<span class="p">,</span>
  _In_       LPCTSTR lpServiceName<span class="p">,</span>
  _In_opt_   LPCTSTR lpDisplayName<span class="p">,</span>
  _In_       DWORD dwDesiredAccess<span class="p">,</span>
  _In_       DWORD dwServiceType<span class="p">,</span>
  _In_       DWORD dwStartType<span class="p">,</span>
  _In_       DWORD dwErrorControl<span class="p">,</span>
  _In_opt_   LPCTSTR lpBinaryPathName<span class="p">,</span>
  _In_opt_   LPCTSTR lpLoadOrderGroup<span class="p">,</span>
  _Out_opt_  LPDWORD lpdwTagId<span class="p">,</span>
  _In_opt_   LPCTSTR lpDependencies<span class="p">,</span>
  _In_opt_   LPCTSTR lpServiceStartName<span class="p">,</span>
  _In_opt_   LPCTSTR lpPassword
);


BOOL WINAPI StartService(
  _In_      SC_HANDLE hService<span class="p">,</span>
  _In_      DWORD dwNumServiceArgs<span class="p">,</span>
  _In_opt_  LPCTSTR *lpServiceArgVectors
);
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              9/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-10">
          <div class="inner">
            
            <header><h1>Start Types</h1></header>
            
            
            <section><pre><code>| Name                 | Hex  |
|----------------------|------|
| SERVICE_AUTO_START   | 0x02 |
| SERVICE_BOOT_START   | 0x00 |
| SERVICE_DEMAND_START | 0x03 |
| SERVICE_DISABLED     | 0x04 |
| SERVICE_SYSTEM_START | 0x01 |
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              10/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-11">
          <div class="inner">
            
            <header><h1>Service Types</h1></header>
            
            
            <section><pre><code>| Name                        | Hex  |
|-----------------------------|------|
| SERVICE_ADAPTER             | 0x04 |
| SERVICE_FILE_SYSTEM_DRIVER  | 0x02 |
| SERVICE_KERNEL_DRIVER       | 0x01 |
| SERVICE_RECOGNIZER_DRIVER   | 0x08 |
| SERVICE_WIN32_OWN_PROCESS   | 0x10 |
| SERVICE_WIN32_SHARE_PROCESS | 0x20 |
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              11/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-12">
          <div class="inner">
            
            <header><h1>Installing Services with Stealth</h1></header>
            
            
            <section><p>Create required registry keys</p>
<p>Call NdrClientCall </p>
<ul>
<li>Interface for StartService</li>
</ul>
<p>Call NtLoadDriver</p>
<ul>
<li>Loads Kernel drver service</li>
</ul>
<p>Both methods AVOID event logs!</p>
<p>After service starts, just delete registry keys!</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              12/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-13">
          <div class="inner">
            
            <header><h1>Stopping Services</h1></header>
            
            
            <section><p>Some malware will stop services</p>
<ul>
<li>net stop <serviceName></li>
<li>ControlService from WinAPI</li>
<li>TerminateProcess from WinAPI</li>
</ul>
<p>Look at stopped and running services! </p>
<p>Wscsvr = Windows Security Center
Wuauserv = Windows Auto Update
WinDefend = Windows Defender
WerSvc = Windows Error Reporting</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              13/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-14">
          <div class="inner">
            
            <header><h1>Services on a Live System</h1></header>
            
            
            <section><p>Services MMC snap-in</p>
<p><img alt="servicesMMC" src="..\slideResources\services\servicesMMC.png" /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              14/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-15">
          <div class="inner">
            
            <header><h1>Services on a Live System</h1></header>
            
            
            <section><p>PowerShell cmdlet Get-Service</p>
<div class="highlight"><pre>PS C:\Users\topher<span class="p">&gt;</span> <span class="n">Get</span>-Service

Status   Name               DisplayName
------   ----               -----------
Running  AeLookupSvc        Application Experience
Stopped  ALG                Application Layer Gateway Service
Stopped  AppIDSvc           Application Identity
Running  Appinfo            Application Information
Stopped  aspnet_state       ASP.NET State Service
Running  AudioEndpointBu... Windows Audio Endpoint Builder
Running  AudioSrv           Windows Audio
Stopped  AxInstSV           ActiveX Installer (AxInstSV)
Stopped  BDESVC             BitLocker Drive Encryption Service
Running  BFE                Base Filtering Engine
Running  BITS               Background Intelligent Transfer Ser...
Stopped  Browser            Computer Browser
Stopped  bthserv            Bluetooth Support Service
Stopped  CertPropSvc        Certificate Propagation
Stopped  clr_optimizatio... Microsoft .NET Framework NGEN v<span class="m">2</span>.<span class="m">0</span>....
Stopped  clr_optimizatio... Microsoft .NET Framework NGEN v<span class="m">2</span>.<span class="m">0</span>....
Stopped  clr_optimizatio... Microsoft .NET Framework NGEN v<span class="m">4</span>.<span class="m">0</span>....
Stopped  clr_optimizatio... Microsoft .NET Framework NGEN v<span class="m">4</span>.<span class="m">0</span>....
Stopped  COMSysApp          COM+ System Application
Running  CryptSvc           Cryptographic Services
Running  DcomLaunch         DCOM Server Process Launcher
Stopped  defragsvc          Disk Defragmenter
Running  Dhcp               DHCP Client
Running  Dnscache           DNS Client
Stopped  dot<span class="m">3</span>svc            Wired AutoConfig
Running  DPS                Diagnostic Policy Service
Running  EapHost            Extensible Authentication Protocol
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              15/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-16">
          <div class="inner">
            
            <header><h1>Services on a Live System</h1></header>
            
            
            <section><p>Sc.exe and Query</p>
<div class="highlight"><pre>C:\Users\topher<span class="p">&gt;</span><span class="n">sc</span> query
DISPLAY_NAME: Power
        TYPE               : <span class="m">20</span>  WIN<span class="m">32</span>_SHARE_PROCESS
        STATE              : <span class="m">4</span>  RUNNING
                                (NOT_STOPPABLE<span class="p">,</span> NOT_PAUSABLE<span class="p">,</span> ACCEPTS_SHUTDOWN)
        WIN<span class="m">32</span>_EXIT_CODE    : <span class="m">0</span>  (<span class="m">0</span>x<span class="m">0</span>)
        SERVICE_EXIT_CODE  : <span class="m">0</span>  (<span class="m">0</span>x<span class="m">0</span>)
        CHECKPOINT         : <span class="m">0</span>x<span class="m">0</span>
        WAIT_HINT          : <span class="m">0</span>x<span class="m">0</span>

SERVICE_NAME: ProfSvc
DISPLAY_NAME: User Profile Service
        TYPE               : <span class="m">20</span>  WIN<span class="m">32</span>_SHARE_PROCESS
        STATE              : <span class="m">4</span>  RUNNING
                                (STOPPABLE<span class="p">,</span> NOT_PAUSABLE<span class="p">,</span> ACCEPTS_SHUTDOWN)
        WIN<span class="m">32</span>_EXIT_CODE    : <span class="m">0</span>  (<span class="m">0</span>x<span class="m">0</span>)
        SERVICE_EXIT_CODE  : <span class="m">0</span>  (<span class="m">0</span>x<span class="m">0</span>)
        CHECKPOINT         : <span class="m">0</span>x<span class="m">0</span>
        WAIT_HINT          : <span class="m">0</span>x<span class="m">0</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              16/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-17">
          <div class="inner">
            
            <header><h1>Services in Memory</h1></header>
            
            
            <section><p>Event Logs </p>
<p>Registry Keys</p>
<p>Services for invalid states</p>
<p>Unlinked Service Records</p>
<p>Hijacked Services</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              17/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-18">
          <div class="inner">
            
            <header><h1>SCM in Memory</h1></header>
            
            
            <section><p>SCM maintains a linked-list of installed services</p>
<p>Magic = Serv or serH</p>
<p>Undocumented</p>
<div class="highlight"><pre>&gt;&gt;&gt; dt<span class="o">(</span><span class="s2">&quot;_SERVICE_HEADER&quot;</span><span class="o">)</span>
 <span class="s1">&#39;_SERVICE_HEADER&#39;</span> <span class="o">(</span>None bytes<span class="o">)</span>
0x0   : Tag                            <span class="o">[</span><span class="s1">&#39;array&#39;</span>, 4, <span class="o">[</span><span class="s1">&#39;unsigned char&#39;</span><span class="o">]]</span>
0xc   : ServiceRecord                  <span class="o">[</span><span class="s1">&#39;pointer&#39;</span>, <span class="o">[</span><span class="s1">&#39;_SERVICE_RECORD&#39;</span><span class="o">]]</span>



&gt;&gt;&gt; dt<span class="o">(</span><span class="s2">&quot;_SERVICE_RECORD&quot;</span><span class="o">)</span>
 <span class="s1">&#39;_SERVICE_RECORD&#39;</span> <span class="o">(</span>None bytes<span class="o">)</span>
0x0   : ServiceList                    <span class="o">[</span><span class="s1">&#39;_SERVICE_LIST_ENTRY&#39;</span><span class="o">]</span>
0x8   : ServiceName                    <span class="o">[</span><span class="s1">&#39;pointer&#39;</span>, <span class="o">[</span><span class="s1">&#39;String&#39;</span>, <span class="o">{</span><span class="s1">&#39;length&#39;</span>: 512, <span class="s1">&#39;encoding&#39;</span>: <span class="s1">&#39;utf16&#39;</span><span class="o">}]]</span>
0xc   : DisplayName                    <span class="o">[</span><span class="s1">&#39;pointer&#39;</span>, <span class="o">[</span><span class="s1">&#39;String&#39;</span>, <span class="o">{</span><span class="s1">&#39;length&#39;</span>: 512, <span class="s1">&#39;encoding&#39;</span>: <span class="s1">&#39;utf16&#39;</span><span class="o">}]]</span>
0x10  : Order                          <span class="o">[</span><span class="s1">&#39;unsigned int&#39;</span><span class="o">]</span>
0x18  : Tag                            <span class="o">[</span><span class="s1">&#39;array&#39;</span>, 4, <span class="o">[</span><span class="s1">&#39;unsigned char&#39;</span><span class="o">]]</span>
0x24  : DriverName                     <span class="o">[</span><span class="s1">&#39;pointer&#39;</span>, <span class="o">[</span><span class="s1">&#39;String&#39;</span>, <span class="o">{</span><span class="s1">&#39;length&#39;</span>: 256, <span class="s1">&#39;encoding&#39;</span>: <span class="s1">&#39;utf16&#39;</span><span class="o">}]]</span>
0x24  : ServiceProcess                 <span class="o">[</span><span class="s1">&#39;pointer&#39;</span>, <span class="o">[</span><span class="s1">&#39;_SERVICE_PROCESS&#39;</span><span class="o">]]</span>
0x28  : Type                           <span class="o">[</span><span class="s1">&#39;Flags&#39;</span>, <span class="o">{</span><span class="s1">&#39;bitmap&#39;</span>: <span class="o">{</span><span class="s1">&#39;SERVICE_KERNEL_DRIVER&#39;</span>: 0, <span class="s1">&#39;SERVICE_WIN32_OWN_PROCESS&#39;</span>: 4, <span class="s1">&#39;SERVICE_WIN32_SHARE_PROCESS&#39;</span>: 5, <span class="s1">&#39;SERVICE_INTERACTIVE_PROCESS&#39;</span>: 8, <span class="s1">&#39;SERVICE_FILE_SYSTEM_DRIVER&#39;</span>: 1<span class="o">}}]</span>
0x2c  : State                          <span class="o">[</span><span class="s1">&#39;Enumeration&#39;</span>, <span class="o">{</span><span class="s1">&#39;target&#39;</span>: <span class="s1">&#39;long&#39;</span>, <span class="s1">&#39;choices&#39;</span>: <span class="o">{</span>1: <span class="s1">&#39;SERVICE_STOPPED&#39;</span>, 2: <span class="s1">&#39;SERVICE_START_PENDING&#39;</span>, 3: <span class="s1">&#39;SERVICE_STOP_PENDING&#39;</span>, 4: <span class="s1">&#39;SERVICE_RUNNING&#39;</span>, 5: <span class="s1">&#39;SERVICE_CONTINUE_PENDING&#39;</span>, 6: <span class="s1">&#39;SERVICE_PAUSE_PENDING&#39;</span>, 7: <span class="s1">&#39;SERVICE_PAUSED&#39;</span><span class="o">}}]</span>
0x44  : Start                          <span class="o">[</span><span class="s1">&#39;Enumeration&#39;</span>, <span class="o">{</span><span class="s1">&#39;target&#39;</span>: <span class="s1">&#39;long&#39;</span>, <span class="s1">&#39;choices&#39;</span>: <span class="o">{</span>0: <span class="s1">&#39;SERVICE_BOOT_START&#39;</span>, 1: <span class="s1">&#39;SERVICE_SYSTEM_START&#39;</span>, 2: <span class="s1">&#39;SERVICE_AUTO_START&#39;</span>, 3: <span class="s1">&#39;SERVICE_DEMAND_START&#39;</span>, 4: <span class="s1">&#39;SERVICE_DISABLED&#39;</span><span class="o">}}]</span>

&gt;&gt;&gt; dt<span class="o">(</span><span class="s2">&quot;_SERVICE_PROCESS&quot;</span><span class="o">)</span>
 <span class="s1">&#39;_SERVICE_PROCESS&#39;</span> <span class="o">(</span>None bytes<span class="o">)</span>
0x8   : BinaryPath                     <span class="o">[</span><span class="s1">&#39;pointer&#39;</span>, <span class="o">[</span><span class="s1">&#39;String&#39;</span>, <span class="o">{</span><span class="s1">&#39;length&#39;</span>: 256, <span class="s1">&#39;encoding&#39;</span>: <span class="s1">&#39;utf16&#39;</span><span class="o">}]]</span>
0xc   : ProcessId                      <span class="o">[</span><span class="s1">&#39;unsigned int&#39;</span><span class="o">]</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <p>Position in the list of ServiceList (only a prevois pointer) indicates start time. typically alphabetically</p>
<p>Win7 has only a </p>
<p>0x0   : prevEntry                    ['_SERVICE_LIST_ENTRY']</p>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              18/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-19">
          <div class="inner">
            
            <header><h1>SvcScan</h1></header>
            
            
            <section><p>Pool tag scan for Windows services</p>
<div class="highlight"><pre><span class="o">[</span>root<span class="p">&amp;</span>windows<span class="o">]</span><span class="c">#volatility -f Lab2.vmem --profile=WinXPSP2x86 svcscan</span>
Volatility Foundation Volatility Framework 2.4
Offset: 0x671e90
Order: 1
Start: SERVICE_DISABLED
Process ID: -
Service Name: Abiosdsk
Display Name: Abiosdsk
Service Type: SERVICE_KERNEL_DRIVER
Service State: SERVICE_STOPPED
Binary Path: -

Offset: 0x671fb0
Order: 3
Start: SERVICE_BOOT_START
Process ID: -
Service Name: ACPI
Display Name: Microsoft ACPI Driver
Service Type: SERVICE_KERNEL_DRIVER
Service State: SERVICE_RUNNING
Binary Path: <span class="se">\D</span>river<span class="se">\A</span>CPI
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              19/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-20">
          <div class="inner">
            
            <header><h1>Recently Created</h1></header>
            
            
            <section><p>Registry keys are updated with a last write timestamp when service is created or modified</p>
<p>Scan all timestamps and view latest ones</p>
<div class="highlight"><pre>&gt;&gt;&gt; import volatility.plugins.registry.registryapi as registryapi
&gt;&gt;&gt; <span class="nv">regapi</span> <span class="o">=</span> registryapi.RegistryApi<span class="o">(</span>self._config<span class="o">)</span>
&gt;&gt;&gt; <span class="nv">key</span> <span class="o">=</span> <span class="s2">&quot;ControlSet001\Services&quot;</span>
&gt;&gt;&gt; <span class="nv">subkeys</span> <span class="o">=</span> regapi.reg_get_all_subkeys<span class="o">(</span><span class="s2">&quot;system&quot;</span>, key<span class="o">)</span>
&gt;&gt;&gt; <span class="nv">services</span> <span class="o">=</span> dict<span class="o">((</span>s.Name, int<span class="o">(</span>s.LastWriteTime<span class="o">))</span> <span class="k">for</span> s in subkeys<span class="o">)</span>
&gt;&gt;&gt; <span class="nb">times</span> <span class="o">=</span> sorted<span class="o">(</span><span class="nb">set</span><span class="o">(</span>services.values<span class="o">())</span>, <span class="nv">reverse</span><span class="o">=</span>True<span class="o">)</span>
&gt;&gt;&gt; <span class="nv">top_three</span> <span class="o">=</span> <span class="nb">times</span><span class="o">[</span>0:3<span class="o">]</span>
&gt;&gt;&gt; <span class="k">for</span> <span class="nb">time </span>in top_three:
...   <span class="k">for</span> name, ts in services.items<span class="o">()</span>:
...     <span class="k">if</span> <span class="nv">ts</span> <span class="o">==</span> <span class="nb">time</span>:
...       print <span class="nb">time</span>, name
...
<span class="m">1428376879</span> driver
<span class="m">1428206878</span> pmem
<span class="m">1428106135</span> DMusic
<span class="m">1428106135</span> swmidi
<span class="m">1428106135</span> drmkaud
<span class="m">1428106135</span> kmixer
<span class="m">1428106135</span> aec
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              20/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-21">
          <div class="inner">
            
            <header><h1>Cross reference with svcscan</h1></header>
            
            
            <section><p>If you find keys, are they in svcscan?</p>
<p>Malware can hide from SCM</p>
<h1>Check if service is running</h1>
<ol>
<li>Find driver name from registry</li>
<li>Scan drivers with modules</li>
</ol></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              21/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-22">
          <div class="inner">
            
            
            <section><div class="highlight"><pre><span class="o">[</span>root<span class="p">&amp;</span>windows<span class="o">]</span><span class="c">#volatility -f Lab2.vmem --profile=WinXPSP2x86 printkey -K &#39;ControlSet001\Services\kmixer&#39;</span>
Volatility Foundation Volatility Framework 2.4
Legend: <span class="o">(</span>S<span class="o">)</span> <span class="o">=</span> Stable   <span class="o">(</span>V<span class="o">)</span> <span class="o">=</span> Volatile

----------------------------
Registry: <span class="se">\D</span>evice<span class="se">\H</span>arddiskVolume1<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\c</span>onfig<span class="se">\s</span>ystem
Key name: kmixer <span class="o">(</span>S<span class="o">)</span>
Last updated: 2015-04-04 00:08:55 UTC+0000

Subkeys:
  <span class="o">(</span>S<span class="o">)</span> Security
  <span class="o">(</span>V<span class="o">)</span> Enum

Values:
REG_DWORD     Type            : <span class="o">(</span>S<span class="o">)</span> 1
REG_DWORD     Start           : <span class="o">(</span>S<span class="o">)</span> 3
REG_DWORD     ErrorControl    : <span class="o">(</span>S<span class="o">)</span> 1
REG_EXPAND_SZ ImagePath       : <span class="o">(</span>S<span class="o">)</span> system32<span class="se">\d</span>rivers<span class="se">\k</span>mixer.sys
REG_SZ        DisplayName     : <span class="o">(</span>S<span class="o">)</span> Microsoft Kernel Wave Audio Mixer

<span class="o">[</span>root<span class="p">&amp;</span>windows<span class="o">]</span><span class="c">#volatility -f Lab2.vmem --profile=WinXPSP2x86 modules | grep kmixer.sys</span>
Volatility Foundation Volatility Framework 2.4
0x81ee42a0 kmixer.sys           0xb1564000    0x2b000 <span class="se">\S</span>ystemRoot<span class="se">\s</span>ystem32<span class="se">\d</span>rivers<span class="se">\k</span>mixer.sys
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              22/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-23">
          <div class="inner">
            
            <header><h1>Hijacked Services</h1></header>
            
            
            <section><p>Attackers can change path in registry of a service to point to malware .exe, .dll, etc.</p>
<p>Can also overwrite existing DLL or binary</p>
<p>Mandiant APT1 Report shows a lot of 61938 malware hijacks and installs services</p>
<p><a href="http://contagiodump.blogspot.com/2013/03/mandiant-apt1-samples-categorized-by.html" title="APT1 Samples">APT1 Samples</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              23/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-24">
          <div class="inner">
            
            <header><h1>Detecting Hijacked Paths</h1></header>
            
            
            <section><p>Use svcscan and look for ServiceDll and Binary Paths</p>
<p>Compare them with paths from an uninfected system</p>
<p>Pull hypothesized malicious binary out of capture and analyze </p>
<div class="highlight"><pre><span class="o">[</span>root<span class="p">&amp;</span>windows<span class="o">]</span><span class="c">#volatility -f Lab2.vmem --profile=WinXPSP2x86 svcscan -v | egrep &#39;(ServiceDll|Binary Path)&#39;</span>
Volatility Foundation Volatility Framework 2.4
ServiceDll: %SystemRoot%<span class="se">\s</span>ystem32<span class="se">\a</span>lrsvc.dll
Binary Path: C:<span class="se">\W</span>INDOWS<span class="se">\S</span>ystem32<span class="se">\a</span>lg.exe
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\a</span>ppmgmts.dll
Binary Path: C:<span class="se">\W</span>INDOWS<span class="se">\S</span>ystem32<span class="se">\s</span>vchost.exe -k netsvcs
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\a</span>udiosrv.dll
Binary Path: <span class="se">\D</span>river<span class="se">\a</span>udstub
Binary Path: <span class="se">\D</span>river<span class="se">\B</span>eep
ServiceDll: C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\q</span>mgr.dll
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\b</span>rowser.dll
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              24/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-25">
          <div class="inner">
            
            <header><h1>Get a Baseline of Service DLLs</h1></header>
            
            
            <section><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pywintypes</span><span class="o">,</span> <span class="nn">win32api</span><span class="o">,</span> <span class="nn">win32con</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

  <span class="n">w32</span> <span class="o">=</span> <span class="n">win32con</span>

  <span class="n">read_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">w32</span><span class="o">.</span><span class="n">KEY_READ</span> <span class="o">|</span>
    <span class="n">w32</span><span class="o">.</span><span class="n">KEY_ENUMERATE_SUB_KEYS</span> <span class="o">|</span> 
    <span class="n">w32</span><span class="o">.</span><span class="n">KEY_QUERY_VALUE</span><span class="p">)</span>

  <span class="n">hkey</span> <span class="o">=</span> <span class="n">win32api</span><span class="o">.</span><span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">w32</span><span class="o">.</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span> 
    <span class="s">&quot;System</span><span class="se">\\</span><span class="s">ControlSet001</span><span class="se">\\</span><span class="s">Services&quot;</span><span class="p">,</span> 
    <span class="mi">0</span><span class="p">,</span> 
    <span class="n">read_flags</span><span class="p">)</span>

  <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">win32api</span><span class="o">.</span><span class="n">RegEnumKeyEx</span><span class="p">(</span><span class="n">hkey</span><span class="p">)]</span>

  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

    <span class="k">try</span><span class="p">:</span>

      <span class="n">subkey</span> <span class="o">=</span> <span class="n">win32api</span><span class="o">.</span><span class="n">RegOpenKeyEx</span><span class="p">(</span>
        <span class="n">hkey</span><span class="p">,</span>
        <span class="s">&quot;</span><span class="si">%s</span><span class="se">\\</span><span class="s">Parameters&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">read_flags</span><span class="p">)</span>

      <span class="n">value</span> <span class="o">=</span> <span class="n">win32api</span><span class="o">.</span><span class="n">RegQueryValueEx</span><span class="p">(</span>
        <span class="n">subkey</span><span class="p">,</span>
        <span class="s">&quot;ServiceDll&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">pywintypes</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
      <span class="k">continue</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">win32api</span><span class="o">.</span><span class="n">ExpandEnvironmentStrings</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;c:\windows&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> 
      <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;c:\windows&quot;</span><span class="p">,</span> <span class="s">&quot;%SYSTEMROOT%&quot;</span><span class="p">)</span>
      <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">main</span><span class="p">()</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              25/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-26">
          <div class="inner">
            
            <header><h1>And use them</h1></header>
            
            
            <section><div class="highlight"><pre>c:<span class="se">\P</span>ython27&gt;python.exe Scripts<span class="se">\s</span>erviceDll.py
%SYSTEMROOT%<span class="se">\s</span>ystem32<span class="se">\a</span>elupsvc.dll
%SYSTEMROOT%<span class="se">\s</span>ystem32<span class="se">\a</span>ppidsvc.dll
%SYSTEMROOT%<span class="se">\s</span>ystem32<span class="se">\a</span>ppinfo.dll
<span class="o">[</span>SNIP<span class="o">]</span>
</pre></div>

<p><br></p>
<div class="highlight"><pre><span class="o">[</span>root<span class="p">&amp;</span>windows<span class="o">]</span><span class="c">#volatility -f Win7.bin --profile=Win7SP0x86 svcscan -v | grep ServiceDll </span>
ServiceDll: %SystemRoot%<span class="se">\s</span>ystem32<span class="se">\w</span>di.dll
ServiceDll: %SystemRoot%<span class="se">\s</span>ystem32<span class="se">\w</span>di.dll
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\W</span>csPlugInService.dll
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\w</span>cncsvc.dll
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\w</span>biosrvc.dll
ServiceDll: %systemroot%<span class="se">\s</span>ystem32<span class="se">\w</span>32time.dll
ServiceDll: %SystemRoot%<span class="se">\s</span>ystem32<span class="se">\w</span>pdbusenum.dll
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\w</span>pcsvc.dll
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\w</span>lansvc.dll
ServiceDll: %SystemRoot%<span class="se">\s</span>ystem32<span class="se">\W</span>smSvc.dll
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\w</span>scsvc.dll
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\w</span>wansvc.dll
ServiceDll: %SystemRoot%<span class="se">\S</span>ystem32<span class="se">\W</span>UDFSvc.dll
ServiceDll: %systemroot%<span class="se">\s</span>ystem32<span class="se">\w</span>uaueng.dll
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              26/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-27">
          <div class="inner">
            
            <header><h1>Detecting Hijacked disk Binaries</h1></header>
            
            
            <section><p>Malware can just overwrite a binary on disk </p>
<p>Hard to detect</p>
<p>Hashing from Volatility and on disk does not work</p>
<p>Look at artifacts of DLL</p>
<p>Dump DLLs and compare them to ones of disk</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              27/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-28">
          <div class="inner">
            
            <header><h1>Dump All Dlls from Services</h1></header>
            
            
            <section><ol>
<li>Svcscan to list all ServiceDlls</li>
<li>Dump files that matched above output</li>
<li>Run each file through virus scanner or analyze</li>
<li>???</li>
<li>Profit</li>
</ol>
<p><br></p>
<div class="highlight"><pre><span class="o">[</span>root<span class="p">&amp;</span>windows<span class="o">]</span><span class="c">#volatility -f Win7.bin --profile=Win7SP0x86 svcscan -v | grep ServiceDll &gt; serviceDlls</span>
<span class="o">[</span>root<span class="p">&amp;</span>windows<span class="o">]</span><span class="c">#sed &#39;s/ServiceDll: %SystemRoot%\\System32\\//gI&#39; serviceDlls &gt; serviceDllSed</span>

<span class="o">[</span>root<span class="p">&amp;</span>windows<span class="o">]</span><span class="c">#cat serviceDllSed | while read dll; do volatility -f Win7.bin --profile=Win7SP0x86 dlldump -r $dl^C-D serviceDllDump/; done</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              28/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-29">
          <div class="inner">
            
            <header><h1>VirusTotal</h1></header>
            
            
            <section><p>Run each file through virus scanner or analyze</p>
<p>VirusTotal is a free service that analyzes suspicious files and URLs and facilitates the quick detection of viruses, worms, trojans, and all kinds of malware.</p>
<p>Use the VirusTotal API to scan all the DLLs that were dumped </p>
<p>VirusTotal Public API keys are free </p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              29/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-30">
          <div class="inner">
            
            <header><h1>API</h1></header>
            
            
            <section><p>I used <a href="https://github.com/Gawen/virustotal">https://github.com/Gawen/virustotal</a> as main module</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">virustotal</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>

<span class="n">indir</span> <span class="o">=</span> <span class="s">&#39;/root/amf/windows/serviceDllDump/&#39;</span>

<span class="n">virus</span> <span class="o">=</span> <span class="n">virustotal</span><span class="o">.</span><span class="n">VirusTotal</span><span class="p">(</span><span class="s">&#39;API_KEY_HERE&#39;</span><span class="p">)</span>

<span class="n">fileNames</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">indir</span><span class="p">))</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fileNames</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="n">report</span> <span class="o">=</span> <span class="n">virus</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="n">report</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
  <span class="k">assert</span> <span class="n">report</span><span class="o">.</span><span class="n">done</span> <span class="o">==</span> <span class="bp">True</span>
  <span class="k">print</span> <span class="s">&quot;Report&quot;</span>
  <span class="k">print</span> <span class="s">&quot;- Resource&#39;s UID:&quot;</span><span class="p">,</span><span class="n">report</span><span class="o">.</span><span class="n">id</span>
  <span class="k">print</span> <span class="s">&quot;- Scan&#39;s UID:&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">scan_id</span>
  <span class="k">print</span> <span class="s">&quot;- Permalink:&quot;</span> <span class="p">,</span><span class="n">report</span><span class="o">.</span><span class="n">permalink</span>
  <span class="k">print</span> <span class="s">&quot;- Resource&#39;s MD5:&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">md5</span>
  <span class="k">print</span> <span class="s">&quot;- Resource&#39;s status:&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">status</span>
  <span class="k">print</span> <span class="s">&quot;- Antivirus&#39; total:&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">total</span>
  <span class="k">print</span> <span class="s">&quot;- Antivirus&#39;s positives:&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">positives</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              30/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide has_code slide-31">
          <div class="inner">
            
            <header><h1>Results</h1></header>
            
            
            <section><p><em>Note: Permalink lets you see VirusTotal results from web</em></p>
<div class="highlight"><pre>module.352.3dc5b420.71330000.dll
Report
- Resource<span class="s1">&#39;s UID: 8b641606bef10135ba8ef342a99f41dde8be69af53dd039ba3834fe0c8c36010-1428875468</span>
<span class="s1">- Scan&#39;</span>s UID: 8b641606bef10135ba8ef342a99f41dde8be69af53dd039ba3834fe0c8c36010-1428875468
- Permalink: https://www.virustotal.com/file/8b641606bef10135ba8ef342a99f41dde8be69af53dd039ba3834fe0c8c36010/analysis/1428875468/
- Resource<span class="s1">&#39;s MD5: a58b2a03fe4edbebd43c12a4564ce9ae</span>
<span class="s1">- Resource&#39;</span>s status: Scan finished, information embedded
- Antivirus<span class="s1">&#39; total: 56</span>
<span class="s1">- Antivirus&#39;</span>s positives: 0
</pre></div>

<p>Virus sandboxes are not end all be all, but there are a good start! </p>
<p>Takes a minute or two per DLL... run then go to lunch! :)</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              31/32
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: week05_01-Services.md -->
      <div class="slide-wrapper">
        <div class="slide slide-32">
          <div class="inner">
            
            <header><h1>EOF</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            <aside class="source">
              Source: <a href="week05_01-Services.md">week05_01-Services.md</a>
            </aside>
            
            <aside class="page_number">
              32/32
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1">Services</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide2">What</a></th>
        <td><a href="#slide2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide3">Services</a></th>
        <td><a href="#slide3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide4">Service Architecture</a></th>
        <td><a href="#slide4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide5">Subkeys</a></th>
        <td><a href="#slide5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide6">Components</a></th>
        <td><a href="#slide6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide7">Installing Services</a></th>
        <td><a href="#slide7">7</a></td>
      </tr>
      
      
      <tr id="toc-row-8">
        <th><a href="#slide8">Sc.exe</a></th>
        <td><a href="#slide8">8</a></td>
      </tr>
      
      
      <tr id="toc-row-9">
        <th><a href="#slide9">WinAPI</a></th>
        <td><a href="#slide9">9</a></td>
      </tr>
      
      
      <tr id="toc-row-10">
        <th><a href="#slide10">Start Types</a></th>
        <td><a href="#slide10">10</a></td>
      </tr>
      
      
      <tr id="toc-row-11">
        <th><a href="#slide11">Service Types</a></th>
        <td><a href="#slide11">11</a></td>
      </tr>
      
      
      <tr id="toc-row-12">
        <th><a href="#slide12">Installing Services with Stealth</a></th>
        <td><a href="#slide12">12</a></td>
      </tr>
      
      
      <tr id="toc-row-13">
        <th><a href="#slide13">Stopping Services</a></th>
        <td><a href="#slide13">13</a></td>
      </tr>
      
      
      <tr id="toc-row-14">
        <th><a href="#slide14">Services on a Live System</a></th>
        <td><a href="#slide14">14</a></td>
      </tr>
      
      
      <tr id="toc-row-15">
        <th><a href="#slide15">Services on a Live System</a></th>
        <td><a href="#slide15">15</a></td>
      </tr>
      
      
      <tr id="toc-row-16">
        <th><a href="#slide16">Services on a Live System</a></th>
        <td><a href="#slide16">16</a></td>
      </tr>
      
      
      <tr id="toc-row-17">
        <th><a href="#slide17">Services in Memory</a></th>
        <td><a href="#slide17">17</a></td>
      </tr>
      
      
      <tr id="toc-row-18">
        <th><a href="#slide18">SCM in Memory</a></th>
        <td><a href="#slide18">18</a></td>
      </tr>
      
      
      <tr id="toc-row-19">
        <th><a href="#slide19">SvcScan</a></th>
        <td><a href="#slide19">19</a></td>
      </tr>
      
      
      <tr id="toc-row-20">
        <th><a href="#slide20">Recently Created</a></th>
        <td><a href="#slide20">20</a></td>
      </tr>
      
      
      <tr id="toc-row-21">
        <th><a href="#slide21">Cross reference with svcscan</a></th>
        <td><a href="#slide21">21</a></td>
      </tr>
      
      
      <tr id="toc-row-22">
        <th><a href="#slide22">-</a></th>
        <td><a href="#slide22">22</a></td>
      </tr>
      
      
      <tr id="toc-row-23">
        <th><a href="#slide23">Hijacked Services</a></th>
        <td><a href="#slide23">23</a></td>
      </tr>
      
      
      <tr id="toc-row-24">
        <th><a href="#slide24">Detecting Hijacked Paths</a></th>
        <td><a href="#slide24">24</a></td>
      </tr>
      
      
      <tr id="toc-row-25">
        <th><a href="#slide25">Get a Baseline of Service DLLs</a></th>
        <td><a href="#slide25">25</a></td>
      </tr>
      
      
      <tr id="toc-row-26">
        <th><a href="#slide26">And use them</a></th>
        <td><a href="#slide26">26</a></td>
      </tr>
      
      
      <tr id="toc-row-27">
        <th><a href="#slide27">Detecting Hijacked disk Binaries</a></th>
        <td><a href="#slide27">27</a></td>
      </tr>
      
      
      <tr id="toc-row-28">
        <th><a href="#slide28">Dump All Dlls from Services</a></th>
        <td><a href="#slide28">28</a></td>
      </tr>
      
      
      <tr id="toc-row-29">
        <th><a href="#slide29">VirusTotal</a></th>
        <td><a href="#slide29">29</a></td>
      </tr>
      
      
      <tr id="toc-row-30">
        <th><a href="#slide30">API</a></th>
        <td><a href="#slide30">30</a></td>
      </tr>
      
      
      <tr id="toc-row-31">
        <th><a href="#slide31">Results</a></th>
        <td><a href="#slide31">31</a></td>
      </tr>
      
      
      <tr id="toc-row-32">
        <th><a href="#slide32">EOF</a></th>
        <td><a href="#slide32">32</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Exposé</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
</body>
</html>
